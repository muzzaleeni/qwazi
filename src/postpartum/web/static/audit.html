<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Postpartum Triage History</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&family=IBM+Plex+Sans:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <main class="page">
      <header class="hero">
        <p class="eyebrow">Germany Workflow / English Locale</p>
        <h1>Postpartum Triage History</h1>
        <p>Recent persistent triage events from local SQLite history.</p>
        <p class="hero-links"><a href="/">Back to Triage Form</a></p>
      </header>

      <section class="panel">
        <div class="auth-controls">
          <input id="auth-username" type="text" placeholder="Username (e.g. coordinator-a)" />
          <input id="auth-password" type="password" placeholder="Password" />
          <button id="auth-login" type="button">Sign in</button>
          <button id="auth-logout" type="button" class="hidden">Sign out</button>
          <span id="auth-state" class="status">Checking session…</span>
        </div>

        <div class="dashboard-toolbar">
          <label>
            Queue
            <select id="queue-filter">
              <option value="ALL">All</option>
              <option value="NEEDS_FOLLOW_UP_TODAY">Needs follow-up today</option>
              <option value="OVERDUE">Overdue</option>
              <option value="CLOSED">Closed</option>
            </select>
          </label>
          <label>
            Limit
            <input id="limit" type="number" min="1" max="200" value="50" />
          </label>
          <button id="refresh" type="button">Refresh</button>
          <span id="status" class="status">Loading…</span>
        </div>

        <div class="metrics">
          <article>
            <p class="metric-label">Escalation Compliance</p>
            <p id="metric-compliance" class="metric-value">-</p>
          </article>
          <article>
            <p class="metric-label">Median Time to Care</p>
            <p id="metric-median-time" class="metric-value">-</p>
          </article>
          <article>
            <p class="metric-label">Emergency Share</p>
            <p id="metric-emergency-share" class="metric-value">-</p>
          </article>
          <article>
            <p class="metric-label">Uncertainty Escalation Share</p>
            <p id="metric-uncertainty-share" class="metric-value">-</p>
          </article>
          <article>
            <p class="metric-label">Overdue Open Cases</p>
            <p id="metric-overdue-open" class="metric-value">-</p>
          </article>
          <article>
            <p class="metric-label">Median Time to Close</p>
            <p id="metric-time-to-close" class="metric-value">-</p>
          </article>
          <article>
            <p class="metric-label">Open High-Risk Cases</p>
            <p id="metric-open-high-risk" class="metric-value">-</p>
          </article>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Timestamp</th>
                <th>Level</th>
                <th>Route</th>
                <th>Escalated</th>
                <th>Red Flags</th>
                <th>Score</th>
                <th>Confidence</th>
                <th>Status</th>
                <th>Owner</th>
                <th>Follow-up Due</th>
                <th>Outcome</th>
                <th>Last Updated</th>
                <th>Source</th>
                <th>Run ID</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="rows">
              <tr><td colspan="15">No data.</td></tr>
            </tbody>
          </table>
        </div>

        <section class="outcome-editor hidden" id="outcome-editor">
          <h3>Update Case</h3>
          <p class="hint">This updates outcome and workflow fields in persistent history.</p>
          <p class="hint" id="editor-meta"></p>
          <form id="outcome-form">
            <input id="outcome-event-id" type="hidden" />
            <div class="outcome-grid">
              <label>
                Status
                <select id="workflow-status">
                  <option value="NEW">NEW</option>
                  <option value="IN_PROGRESS">IN_PROGRESS</option>
                  <option value="WAITING">WAITING</option>
                  <option value="CLOSED">CLOSED</option>
                </select>
              </label>
              <label>
                Owner
                <input id="workflow-owner" type="text" placeholder="e.g. coordinator-a" />
              </label>
              <label>
                Follow-up due
                <input id="workflow-follow-up-due" type="datetime-local" />
              </label>
              <label>
                Last contact
                <input id="workflow-last-contact" type="datetime-local" />
              </label>
            </div>
            <div class="outcome-grid">
              <label>
                Care sought
                <select id="outcome-care-sought">
                  <option value="">Unknown</option>
                  <option value="true">Yes</option>
                  <option value="false">No</option>
                </select>
              </label>
              <label>
                Care time (hours)
                <input id="outcome-care-time" type="number" min="0" step="0.1" />
              </label>
              <label>
                Care type
                <select id="outcome-care-type">
                  <option value="">Unknown</option>
                  <option value="EMERGENCY">Emergency</option>
                  <option value="PSYCHIATRY">Psychiatry</option>
                  <option value="OBGYN">OB-GYN</option>
                  <option value="HAUSARZT">Hausarzt</option>
                  <option value="MIDWIFE">Hebamme</option>
                  <option value="OTHER">Other</option>
                </select>
              </label>
              <label>
                Resolved
                <select id="outcome-resolved">
                  <option value="">Unknown</option>
                  <option value="true">Yes</option>
                  <option value="false">No</option>
                </select>
              </label>
            </div>
            <label>
              Notes
              <textarea id="outcome-notes" rows="3"></textarea>
            </label>
            <div class="actions">
              <button type="submit">Save Outcome</button>
              <button type="button" id="outcome-cancel">Cancel</button>
            </div>
          </form>
        </section>

        <section class="change-history" id="change-history">
          <div class="change-history-head">
            <h3>Recent Change History</h3>
            <p class="hint" id="change-status">Sign in to view immutable edit history.</p>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Timestamp</th>
                  <th>Editor</th>
                  <th>Change Type</th>
                  <th>Case Event ID</th>
                  <th>Patch</th>
                </tr>
              </thead>
              <tbody id="change-rows">
                <tr><td colspan="5">Sign in to load change history.</td></tr>
              </tbody>
            </table>
          </div>
        </section>
      </section>
    </main>
    <script src="/audit.js"></script>
  </body>
</html>
